{% extends "base.html" %}
{% block title %}문서 수정 - School Wiki{% endblock %}
{% block content %}
<h2>문서 수정</h2>
<form method="post">
  <p><input type="text" name="title" value="{{ page['title'] }}" placeholder="제목"></p>
  <p>
    <label>상위 문서(선택)</label>
    <select name="parent_id">
      <option value="">(없음)</option>
      {% for p in all_pages %}
        <option value="{{ p['id'] }}" {% if page['parent_id']==p['id'] %}selected{% endif %}>{{ p['title'] }}</option>
      {% endfor %}
    </select>
  </p>
  <p><textarea name="content" placeholder="내용" id="content">{{ page['content'] }}</textarea>
  </p>
  <div class="uploader">
    <input type="file" id="imgfile" accept="image/*">
    <button class="btn" type="button" onclick="uploadImage()">이미지 업로드</button>
    <span id="uplog" class="meta"></span>
  </div>
  <script>
  async function uploadImage(){
    const fileInput = document.getElementById('imgfile');
    if(!fileInput || !fileInput.files || !fileInput.files[0]){
      document.getElementById('uplog').textContent = '파일을 선택하세요';
      return;
    }
    const fd = new FormData();
    fd.append('image', fileInput.files[0]);
    const res = await fetch('/upload', {method:'POST', body: fd});
    const data = await res.json();
    if(!data.ok){
      document.getElementById('uplog').textContent = data.error || '업로드 실패';
      return;
    }
    const url = data.url;
    const ta = document.getElementById('content');
    const alt = fileInput.files[0].name;
    const insert = `![$${'{'}alt{'}'}](${ '${'}url${'}'})`;
    // insert at caret
    const start = ta.selectionStart || 0;
    const end = ta.selectionEnd || 0;
    const before = ta.value.substring(0, start);
    const after = ta.value.substring(end);
    ta.value = before + insert + after;
    ta.focus();
    ta.selectionStart = ta.selectionEnd = (before + insert).length;
    document.getElementById('uplog').textContent = '삽입됨';
  }
  </script>
  <p>
    <input type="text" name="author" placeholder="작성자">
    <input type="text" name="summary" placeholder="변경 요약(선택)">
  </p>
  <p>
    <button class="btn primary" type="submit">저장</button>
    <a class="btn" href="{{ url_for('view_page', page_id=page['id']) }}">취소</a>
  </p>
</form>
{% endblock %}
